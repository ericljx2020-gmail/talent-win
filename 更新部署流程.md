# 网站更新部署流程

## 🔄 完整更新流程

### 方案A：使用Git（推荐）

这是最规范和便捷的方式。

#### 准备工作（一次性设置）

**1. 在GitHub创建仓库**

```bash
# 在本地Mac电脑上（talent-win项目目录）
cd /Users/eureka/Desktop/Projects/talent-win

# 初始化Git（如果还没有）
git init

# 创建 .gitignore（如果还没有）
cat > .gitignore << 'EOF'
node_modules/
dist/
.env
.DS_Store
*.log
EOF

# 提交所有代码
git add .
git commit -m "Initial commit"

# 关联GitHub仓库（替换为你的仓库地址）
git remote add origin https://github.com/your-username/talent-win.git
git branch -M main
git push -u origin main
```

**2. 在服务器上克隆仓库（首次）**

```bash
# SSH登录到阿里云服务器
ssh root@8.153.166.197

# 如果之前是用SCP上传的，先备份并删除
cd /root
mv talent-win talent-win-backup

# 克隆GitHub仓库
git clone https://github.com/your-username/talent-win.git
cd talent-win
```

#### 日常更新流程

**步骤1：在本地修改代码**

```bash
# 在你的Mac电脑上修改代码
# 比如修改 src/components/Hero.tsx 等文件
```

**步骤2：提交代码到GitHub**

```bash
# 在本地项目目录
cd /Users/eureka/Desktop/Projects/talent-win

# 查看修改的文件
git status

# 添加修改的文件
git add .

# 提交修改（写清楚改了什么）
git commit -m "更新了首页标题和联系表单"

# 推送到GitHub
git push origin main
```

**步骤3：在服务器上更新部署**

```bash
# SSH登录到服务器
ssh root@8.153.166.197

# 进入项目目录
cd /root/talent-win

# 方法1：使用自动部署脚本（推荐）
./deploy-aliyun.sh
# 然后选择：2（更新部署）

# 方法2：手动执行
git pull origin main              # 拉取最新代码
docker-compose down               # 停止旧容器
docker-compose up -d --build      # 重新构建并启动
docker image prune -f             # 清理旧镜像
```

**步骤4：验证更新**

```bash
# 查看容器状态
docker-compose ps

# 查看日志（确保没有错误）
docker-compose logs -f --tail=50

# 在浏览器访问测试
# http://8.153.166.197:8080
```

---

### 方案B：使用SCP上传（不推荐，但可用）

如果暂时不想用Git，也可以直接上传文件。

**步骤1：在本地打包项目**

```bash
# 在Mac电脑上
cd /Users/eureka/Desktop/Projects/talent-win

# 打包项目（排除不需要的文件）
tar --exclude='node_modules' \
    --exclude='dist' \
    --exclude='.git' \
    --exclude='.DS_Store' \
    -czf talent-win-update.tar.gz .
```

**步骤2：上传到服务器**

```bash
# 上传压缩包
scp talent-win-update.tar.gz root@8.153.166.197:/root/

# SSH登录到服务器
ssh root@8.153.166.197
```

**步骤3：解压并部署**

```bash
# 停止服务
cd /root/talent-win
docker-compose down

# 备份当前版本（可选但推荐）
cd /root
cp -r talent-win talent-win-backup-$(date +%Y%m%d)

# 解压新代码（覆盖旧文件）
cd /root/talent-win
tar -xzf ../talent-win-update.tar.gz

# 重新部署
docker-compose up -d --build
docker image prune -f

# 清理压缩包
rm /root/talent-win-update.tar.gz
```

**步骤4：验证更新**

```bash
docker-compose ps
docker-compose logs -f --tail=50
```

---

## 📋 更新检查清单

更新前检查：
- [ ] 本地代码已测试无误
- [ ] 已提交所有修改到Git（如果使用Git）
- [ ] 记录了本次修改的内容

更新后检查：
- [ ] 容器状态正常（`docker-compose ps` 显示 Up）
- [ ] 日志无错误信息
- [ ] 网站可以正常访问
- [ ] 关键功能测试通过（导航、表单等）

---

## ⚡ 快捷命令

```bash
# ========== 本地（Mac）==========

# 提交并推送代码
git add . && git commit -m "更新说明" && git push

# 连接到服务器
ssh root@8.153.166.197

# ========== 服务器 ==========

# 快速更新（一行命令）
cd /root/talent-win && git pull && docker-compose down && docker-compose up -d --build && docker image prune -f

# 或使用脚本（推荐）
cd /root/talent-win && ./deploy-aliyun.sh
# 选择：2

# 查看状态
docker-compose ps

# 实时查看日志
docker-compose logs -f

# 重启服务（不重新构建）
docker-compose restart

# 查看资源使用
docker stats talent-win-web
```

---

## 🚨 常见问题

### 更新后网站没有变化？

**原因：** 浏览器缓存

**解决：**
- 按 `Ctrl+Shift+R`（Windows）或 `Cmd+Shift+R`（Mac）强制刷新
- 或者清除浏览器缓存

### Git拉取失败？

```bash
# 查看状态
git status

# 如果有本地修改冲突，先保存
git stash

# 拉取最新代码
git pull origin main

# 恢复本地修改（如果需要）
git stash pop
```

### 构建失败？

```bash
# 查看详细错误
docker-compose up --build

# 清理所有容器和镜像重新开始
docker-compose down
docker system prune -a
docker-compose up -d --build
```

### 回滚到之前的版本

**如果使用Git：**
```bash
# 查看提交历史
git log --oneline

# 回滚到指定版本（替换commit-id）
git reset --hard <commit-id>
docker-compose down
docker-compose up -d --build
```

**如果有备份：**
```bash
# 停止服务
cd /root/talent-win
docker-compose down

# 恢复备份
cd /root
rm -rf talent-win
cp -r talent-win-backup-20241029 talent-win

# 重新启动
cd talent-win
docker-compose up -d
```

---

## 💡 最佳实践

### 1. 使用分支开发

```bash
# 创建开发分支
git checkout -b dev

# 在开发分支上修改和测试
# ... 修改代码 ...
git add .
git commit -m "新功能开发"

# 测试通过后合并到主分支
git checkout main
git merge dev
git push origin main

# 然后在服务器上拉取更新
```

### 2. 版本标签管理

```bash
# 打标签标记重要版本
git tag -a v1.0.0 -m "第一个正式版本"
git push origin v1.0.0

# 查看所有标签
git tag

# 回滚到特定标签
git checkout v1.0.0
```

### 3. 自动化部署（进阶）

可以使用GitHub Actions实现自动部署：

**创建 `.github/workflows/deploy.yml`：**

```yaml
name: Deploy to Aliyun

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /root/talent-win
            git pull origin main
            docker-compose down
            docker-compose up -d --build
            docker image prune -f
```

这样每次 `git push` 就会自动部署到服务器！

### 4. 定期备份

```bash
# 创建备份脚本
cat > /root/backup-website.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/root/backups"
mkdir -p $BACKUP_DIR

# 备份代码
tar -czf $BACKUP_DIR/talent-win-$DATE.tar.gz /root/talent-win

# 只保留最近7天的备份
find $BACKUP_DIR -name "talent-win-*.tar.gz" -mtime +7 -delete

echo "备份完成: talent-win-$DATE.tar.gz"
EOF

chmod +x /root/backup-website.sh

# 添加定时任务（每天凌晨2点备份）
crontab -e
# 添加：0 2 * * * /root/backup-website.sh
```

---

## 📞 需要帮助？

如果更新过程中遇到问题：

1. 查看日志：`docker-compose logs -f`
2. 检查容器状态：`docker-compose ps`
3. 检查磁盘空间：`df -h`
4. 检查内存使用：`free -h`

---

**总结：推荐使用 Git + 自动脚本的方式，简单、安全、可追溯！** 🚀

